以下は **半導体製造（CVD/ALD）用途**で「反応ネットワーク縮退（削除＋マージ＋任意状態化）」を行うときに、**特定ガスや今回のテストケースに依存しない**形で有用な **制約（constraints）**と **条件（conditions）の入れ方**を、できるだけ **反応速度論・反応ネットワーク理論・熱力学**に基づいて整理したものです。
（“後から補正する”系ではなく、**モデル設計／学習目的／状態表現**に埋め込む方向を主にします）

---

## 0. 前提：CVD/ALD縮退で「守るべきもの」は燃焼より構造的に厳しい

燃焼縮退（例：IDT・火炎速度保持）と比べ、CVD/ALDは

* **多相（気相＋表面＋場合によりバルク堆積）**
* **表面サイト制約（被覆率が [0,1]、サイトタイプも複数）**
* **パルス運転（ALD：周期的外力で支配反応が位相ごとに切替）**
* **“成膜/エッチ”という入出力（KPI）が明確**

という性質があるため、縮退時に **保存則＋境界条件＋位相の切替**を壊すと、わずかな誤差が致命的になりがちです。
したがって制約は「精度のため」だけでなく、**縮退モデルを“壊れない動力学系”にするため**に入れます。

---

# 1) 最優先の理論制約（Hard Constraints）

ここは **必ず守る**領域です。入れないと縮退モデルが不安定化したり、パルス長／条件変更で破綻しやすくなります。

## 1.1 元素保存（気相＋表面＋バルク）

**原理**：質量作用則でも有効速度でも、反応が元素を生成することはない（核反応を除く）。
**数学**：元素行列 (A\in\mathbb{R}^{N_e\times N_s})、化学量論行列 (\nu\in\mathbb{R}^{N_s\times N_r}) に対して
[
A,\nu = 0
]
が成立する（閉じた系・その相の定義に従う）。

### 実装の入れ方（縮退に直結）

* **(A) 反応式を残す/再合成する場合**（LearnCK/CRNN/SINDy→CRN等）
  → **縮退反応の化学量論ベクトルを、元素保存を満たす空間（nullspace）から生成**する。
  具体的には、候補反応 (\Delta x) を作る際に「(A\Delta x=0)」を満たすものしか採用しない。
* **(B) マージ（任意状態化）で“組成の違う種”を同じ状態にまとめたい場合**
  ここが重要です。
  **理論的に**、異なる組成（例：CH4 と CH）を “1変数” にマージすると、一般には元素量を一意に表せません。
  これは線形代数の話で、

  * 種 (i) の元素組成ベクトル (a_i\in\mathbb{R}^{N_e}) を並べた行列の **rank** が、その集合を厳密に表すのに必要な最小次元になる
  * 例：CH4 と CH は ([C=1,H=4]) と ([1,1]) なので rank=2
    → **C量とH量の2変数（原子プール）**がないと元素保存は一般に破れます

  ✅ **推奨（理論ベースで“ゆるいマージ”を成立させる方法）**
  「種のモル数」ではなく、**原子プール（element moments）で状態を持つ**

  * C–H族なら (y_C=\sum_i C_i x_i,; y_H=\sum_i H_i x_i)
  * C–F族なら (y_C,; y_F)
  * Si–Cl–O族なら (y_{Si}, y_{Cl}, y_O)
    こうすると **同族内の多くの種を消しても元素保存は厳密に維持**できます。

> まとめ：
> 「異組成マージ」を“理論的に”成立させる鍵は、**状態変数を「種」ではなく「必要最小の元素モーメント」に変える**ことです。
> これは“後から補正”ではなく、**状態表現そのものを物理に合わせる**設計です。

---

## 1.2 表面サイト保存（ALD/CVDで最重要）

**原理**：表面上の占有率の総和はサイト数に制約される（Langmuir型、site balance）。
単一サイトなら
[
\sum_{i\in surface}\theta_i = 1
]
多サイト占有（例：二座占有）や複数サイトタイプ（*A, *B）なら
[
\sum_i s_{i,A}\theta_i = 1,\quad \sum_i s_{i,B}\theta_i = 1
]
（(s_{i,A})：種iがサイトAを占有する数）

### 実装の入れ方

* **表面種のマージ禁止ルール**（hard）

  * 「占有サイト数が違う種を同じ代表状態に入れない」
  * 「サイトタイプが違う種を同じ代表状態に入れない」
* **“ゆるいマージ”をしたい場合（理論ベース）**
  元素保存と同じ発想で、表面では **サイトモーメント**を状態に含める：

  * (y_{A}=\sum_i s_{i,A}\theta_i)（実際は=1固定だが、複数面・欠陥サイトを扱うなら変動要素にもなる）
  * 重要なのは「代表状態が何サイト占有か」を失わないこと

---

## 1.3 非負性・被覆率の範囲

**原理**：濃度は負にならない、被覆率は [0,1] で、サイト制約を満たす。
**実装**：

* 学習モデルの出力（反応速度、ソース項）を

  * `softplus`/exp で正にパラメータ化
  * 被覆率は simplex（softmax）上で表現
* 反応速度の符号は “正味” を直接出すより、**前進・後退を正で出して差を取る**方が安定（次の詳細釣合いとも整合）

---

# 2) 熱力学整合（Thermodynamic Consistency）

ここは “半導体だから特別” ではなく、**長時間・条件変更・位相切替**がある系で破綻しにくくするための理論制約です。

## 2.1 詳細釣合い・平衡整合（可逆反応がある場合）

**原理**：平衡では正味反応速度がゼロ、前進/後退は平衡定数で結ばれる。
[
\frac{k_f}{k_r} = K_{eq}(T)
]
（厳密には活量や標準状態の取り方に依存）

### 実装の入れ方

* **縮退後も可逆反応として残す反応**については

  * 自由パラメータは (k_f) のみにして、(k_r) は (K_{eq}(T)) から決定
  * これで「平衡で正味ゼロ」が構造的に保証されます
* “スーパー反応”をNN/GBDTで表現する場合も、

  * **平衡点（複数T,P）で正味0になる**ように学習制約（平衡状態を教師として追加）
  * これは「後から補正」ではなく **学習目的に平衡制約を入れる**形です

## 2.2 エネルギー整合（必要なら）

等温ベンチなら不要ですが、装置スケールで温度変化を扱う場合：

* 反応熱の符号や、温度依存性が破綻すると、縮退モデルが条件外で暴走します
* 縮退目的が “流体結果が変わらない” なら、温度方程式を回す時点で必須制約になります

---

# 3) “マージ”を理論的に正当化する制約（Lumpability）

あなたのテーマ（階層・循環・マージ）で最も重要な理論がここです。

## 3.1 反応ネットワークの lumpability（近似 lumpability）

反応ネットワークを（反応フラックスなどから）**遷移**とみなすと、
「同じクラスタに入れるべき種」は、

* **外への流出先（どこへ変換されるか）の分布が似ている**
* **外からの流入元の分布が似ている**

という条件を満たすほど、クラスタ化後も同様の動力学が保てます。
これはマルコフ連鎖の “lumpability” の思想に近く、循環（ループ）がある系でも筋が通ります。

### 実装の入れ方（ネットワーク行列を活かす）

あなたが作る (\bar{F})（条件×位相×時間で積分した種→種フラックス）を使い、

* 同クラスタ内の種 i,k について

  * 外向きフラックス分布 (p_{i\to *}) と (p_{k\to *}) の距離（KL/EMD/コサイン）を罰則にする
* “似ていない種は同クラスタに入りにくい” を学習で実現

これにより、**マージが反応論的に妥当な方向へ誘導**されます。
（これはケース依存でなく「反応ネットワークの一般原理」です）

---

# 4) CVD/ALD運転を踏まえた“条件の入れ方”（学習・評価条件設計）

ここは「ガスに依存しない」形で半導体装置らしい条件設計をする部分です。
縮退の成功率は、アルゴリズムより **条件設計**で決まることが多いです。

## 4.1 位相分割（ALDの本質）

ALDは少なくとも

* Pulse（前駆体供給）
* Purge（排気）
* Pulse（共反応剤/プラズマ）
* Purge
  の位相を持ち、支配反応が切り替わります。

**理論的理由**：外力が周期的で、系が非自律系になる（同じ状態でも位相でベクトル場が違う）。
したがって縮退も **位相条件付き**にするのが合理的です。

### 入れ方

* すべての誤差評価・特徴量を **位相ごと**に分ける

  * 例：pulse中の主要反応、purge中の除去反応
* モデル側は

  * 位相IDを入力に入れる
  * あるいは phase別に別モデル（Mixture-of-Experts）
* さらに重要：
  **“位相境界の連続性（状態引き継ぎ）”**を必ず保つ（これは自動的に満たされるが、学習で別モデルに分ける場合に落とし穴）

## 4.2 “露光量（Exposure）”座標で条件を正規化（ALDで特に有効）

ALDは反応が表面律速で、成長が「供給分圧×時間」の積（露光量）で整理できることが多いです。
したがって条件設計では

* (E=\int P_{precursor}(t),dt)
* プラズマなら (E_e=\int f(Te, n_e),dt)（電子温度・密度の指標）

などの **積分量**を軸にして条件を配置すると、縮退が汎化しやすいです。
（これは経験則というより、Langmuir吸着や反応速度論の積分形の帰結です）

## 4.3 CVDは Damköhler（反応/輸送）観点で条件を張る

CVDは反応律速⇔物質移動律速が変わり得ます。
縮退ベンチ条件は、T,P,組成だけでなく

* 滞留時間（流速）
* 反応場の代表長さ（PFR距離）
* 表面反応速度（スティッキング相当）

が変わると律速が変わるので、条件集合は
**「反応律速域」「輸送律速域」「遷移域」**を跨ぐように設計します。
（縮退モデルが“片側の域だけ”で成立しても、装置用途では不十分）

---

# 5) 半導体用途で“守るべきKPI”を制約に落とす（ガス非依存）

縮退の目的関数（精度保持）は、濃度時系列だけでなく **装置KPI**で定義するのが理にかなっています。

代表的KPI（ガスに依存しない形）：

* **成膜速度 / GPC（ALD）**：成長量の位相積分（surface反応速度の積分）
* **膜組成（元素比）**：堆積相への元素流入の積分
* **副生成物の排出量**：排気中の主要副生成物フラックス
* **ラジカル束（プラズマ/熱分解系）**：表面到達束 or 生成ピーク
* **選択比（選択成膜/選択エッチ）**：サイトタイプ別の成長差（モデルが複数表面を持つなら）

### 入れ方（理論ベース）

* これらは本質的に **時間積分量**なので、損失関数も

  * 時間点のMSEより
  * **位相積分誤差**や **1サイクル積分誤差**に重みを置く
* これにより「瞬間の濃度は多少ズレても、装置KPIが合う」縮退が可能になります
  （ALDはまさにその設計が合理的）

---

# 6) 具体的に “制約をどこに入れるか”（あなたのTop4手法に対応）

最後に、あなたが検討している4系統に、制約がどう乗るかを整理します。

## #1 LearnCK++ / CRNN / SRNN 系

* **状態表現**：代表状態（元素モーメント＋必要ならラジカル/サイトモーメント）
* **Hard**：元素保存＋サイト保存を満たす反応化学量論のみを候補にする
* **Thermo**：可逆は (k_f) 自由、(k_r) は (K_{eq}) で決める
* **KPI**：GPC・膜組成・副生成物積分を損失に入れる

## #2 ハイパーグラフPooling（S学習）

* **Hard mask**：

  * gas/surface混合禁止
  * サイト占有数が違う種の混合禁止
  * 電荷状態混合禁止（プラズマ）
* **Soft penalty**：

  * neutral↔radical跨ぎは罰則付きで許容
  * 元素族が遠いほど強罰則
  * lumpability（外向きフラックス分布が似ているほど同クラスタ）
* **位相条件**：位相別 (\bar{F}^{phase}) を入力に入れる

## #3 prune学習→Pooling

* pruneは「多条件で常に効く反応」を残す段階
  → 条件集合の設計（4章）が効く
* prune後にPoolingでマージ
  → lumpabilityペナルティで“変換先が似るもの”をまとめる

## #4 SINDy→CRN再構成

* **状態表現**を先に “元素モーメント＋サイトモーメント” にする
  → そもそも物理保存が入りやすい
* 回帰は **制約付きスパース回帰**

  * 元素保存を満たす項だけをライブラリに入れる
  * あるいは回帰に等式制約を入れる
* 位相ごとに同定する（ALD）か、位相IDを入力に含めた同定をする

---

# 結論：半導体CVD/ALD縮退で「理論に基づき、かつ汎用に効く制約」トップセット

最後に、実務でまず外さない順に並べると：

1. **元素保存（＋必要なら電荷）**：状態表現（元素モーメント）から設計すると“ゆるいマージ”も理論的に成立
2. **表面サイト保存（サイトタイプ・占有数）＋被覆率の範囲**
3. **位相分割（ALD）＋位相積分KPI（GPC/膜組成/副生成物）**
4. **lumpability（フラックス分布類似）**：ネットワーク行列を最大活用できる“理論的マージ誘導”
5. **熱力学整合（可逆・平衡点の正味ゼロ）**：条件外で破綻しにくい

---

